{ lib, pkgs, config, ... }:
let
  get_bufnrs.__raw = ''
    function()
      local buf_size_limit = 1024 * 1024 -- 1MB size limit
      local bufs = vim.api.nvim_list_bufs()
      local valid_bufs = {}
      for _, buf in ipairs(bufs) do
        if vim.api.nvim_buf_is_loaded(buf) and vim.api.nvim_buf_get_offset(buf, vim.api.nvim_buf_line_count(buf)) < buf_size_limit then
          table.insert(valid_bufs, buf)
        end
      end
      return valid_bufs
    end
  '';
in
{
  # Leader
  globals.mapleader = " ";
  # Color Scheme
  colorschemes.gruvbox.enable = true;
  # Plugins
  plugins = {
    mini-pairs.enable = true;
    mini-comment.enable = true;
    mini-git.enable = true;
    mini-statusline.enable = true;
    neoscroll.enable = true;
    todo-comments.enable = true;
    highlight-colors.enable = true;
    emmet.enable = true;
    mini-icons = {
      enable = true;
      mockDevIcons = true;
    };
    cmp = {
      enable = false;
      autoEnableSources = true;
      settings = {
        mapping = {
          "<C-d>" = # Lua
            "cmp.mapping.scroll_docs(-4)";
          "<C-f>" = # Lua
            "cmp.mapping.scroll_docs(4)";
          "<C-Space>" = # Lua
            "cmp.mapping.complete()";
          "<C-e>" = # Lua
            "cmp.mapping.close()";
          "<Tab>" = # Lua
            "cmp.mapping(cmp.mapping.select_next_item({behavior = cmp.SelectBehavior.Select}), {'i', 's'})";
          "<S-Tab>" = # Lua
            "cmp.mapping(cmp.mapping.select_prev_item({behavior = cmp.SelectBehavior.Select}), {'i', 's'})";
          "<CR>" = # Lua
            "cmp.mapping.confirm({ select = false, behavior = cmp.ConfirmBehavior.Replace })";
        };

        preselect = "cmp.PreselectMode.None";

        snippet.expand = "function(args) require('luasnip').lsp_expand(args.body) end";

        sources = [
          {
            name = "nvim_lsp";
            priority = 1000;
            option = {
              inherit get_bufnrs;
            };
          }
          {
            name = "nvim_lsp_signature_help";
            priority = 1000;
            option = {
              inherit get_bufnrs;
            };
          }
          {
            name = "nvim_lsp_document_symbol";
            priority = 1000;
            option = {
              inherit get_bufnrs;
            };
          }
          {
            name = "treesitter";
            priority = 850;
            option = {
              inherit get_bufnrs;
            };
          }
          {
            name = "luasnip";
            priority = 750;
          }
          {
            name = "buffer";
            priority = 500;
            option = {
              inherit get_bufnrs;
            };
          }
          {
            name = "path";
            priority = 300;
          }
          {
            name = "cmdline";
            priority = 300;
          }
          {
            name = "spell";
            priority = 300;
          }
          {
            name = "git";
            priority = 250;
          }
          {
            name = "emoji";
            priority = 100;
          }
        ];
      };
    };
    friendly-snippets.enable = true;
  };
  keymaps = lib.mkIf config.plugins.cmp.enable [
    {
      mode = [
        "i"
        "s"
      ];
      key = "<C-k>";
      action.__raw = ''
        function()
         local ls = require "luasnip" 
         if ls.expand_or_jumpable() then
           ls.expand_or_jump()
         end
        end
      '';
    }
    {
      mode = [
        "i"
        "s"
      ];
      key = "<C-j>";
      action.__raw = ''
        function()
         local ls = require "luasnip" 
         if ls.jumpable(-1) then
           ls.jump(-1)
         end
        end
      '';
    }
  ];
    treesitter = {
      enable = true;
      settings = {
        indent.enable = true;
        highlight.enable = true;
      };
      nixvimInjections = true;
      treesitter-context.enable = true;
      treesitter-textobjects = {
        enable = true;
        select = {
          enable = true;
          lookahead = true;
        };
      };
      grammarPackages = pkgs.vimPlugins.nvim-treesitter.allGrammars;
    };
    telescope = {
      enable = true;
    };
    smear-cursor = {
      enable = true;
      settings = {
        stiffness = 0.8;
        trailing_stiffness = 0.6;
        stiffness_insert_mode = 0.7;
        trailing_stiffness_insert_mode = 0.7;
        damping = 0.95;
        damping_insert_mode = 0.95;
        distance_stop_animating = 0.5;
      };
    };
    oil = {
      enable = true;
      settings = {
        default_file_explorer = true;
        skip_confirm_for_simple_edits = true;
        view_options.show_hidden = true;
        float = {
          padding = 2;
          max_width = 0.6;
          max_height = 0.8;
          border = "rounded";
          win_options.winblend = 0;
        };
      };
    };
    #lspconfig.enable = true;
    conform-nvim = {
      enable = true;
      settings = {
        format_on_save = {
          lspFallback = true;
          timeoutMs = 500;
        };
        notify_on_error = true;
        formatters_by_ft = {
          html = [
            [
              "prettierd"
              "prettier"
            ]
          ];
          css = [
            [
              "prettierd"
              "prettier"
            ]
          ];
          javascript = [
            [
              "prettierd"
              "prettier"
            ]
          ];
          javascriptreact = [
            [
              "prettierd"
              "prettier"
            ]
          ];
          typescript = [
            [
              "prettierd"
              "prettier"
            ]
          ];
          typescriptreact = [
            [
              "prettierd"
              "prettier"
            ]
          ];
          python = [ "black" ];
          lua = [ "stylua" ];
          nix = [ "nixfmt" ];
          markdown = [
            [
              "prettierd"
              "prettier"
            ]
          ];
        };
      };
    };
    blink-cmp-dictionary.enable = true;
    blink-cmp-git.enable = true;
    blink-cmp-spell.enable = true;
    blink-copilot.enable = true;
    blink-emoji.enable = true;
    blink-cmp = {
      enable = true;
      setupLspCapabilities = true;

      settings = {
        keymap = {
          preset = "super-tab";
        };
        signature = {
          enabled = true;
        };

        sources = {
          default = [
            "buffer"
            "lsp"
            "path"
            "snippets"
            # Community
            "dictionary"
            "emoji"
            "git"
            "spell"
          ];
          providers = {
            dictionary = {
              name = "Dict";
              module = "blink-cmp-dictionary";
              min_keyword_length = 3;
            };
            emoji = {
              name = "Emoji";
              module = "blink-emoji";
              score_offset = 1;
            };
            lsp.score_offset = 4;
            spell = {
              name = "Spell";
              module = "blink-cmp-spell";
              score_offset = 1;
            };
            git = {
              name = "Git";
              module = "blink-cmp-git";
              enabled = true;
              score_offset = 100;
              should_show_items.__raw = ''
                function()
                  return vim.o.filetype == 'gitcommit' or vim.o.filetype == 'markdown'
                end
              '';
              opts = {
                git_centers = {
                  github = {
                    issue = {
                      on_error.__raw = "function(_,_) return true end";
                    };
                  };
                };
              };
            };
          };
        };
    };

        appearance = {
          nerd_font_variant = "mono";
          kind_icons = {
            Text = "Û∞âø";
            Method = "Ó™å";
            Function = "Û∞äï";
            Constructor = "Û∞íì";

            Field = "Û∞ú¢";
            Variable = "Û∞Ü¶";
            Property = "Û∞ñ∑";

            Class = "Û±°†";
            Interface = "Û±°†";
            Struct = "Û±°†";
            Module = "Û∞Ö©";

            Unit = "Û∞™ö";
            Value = "Û∞¶®";
            Enum = "Û∞¶®";
            EnumMember = "Û∞¶®";

            Keyword = "Û∞ªæ";
            Constant = "Û∞èø";

            Snippet = "Û±ÑΩ";
            Color = "Û∞èò";
            File = "Û∞àî";
            Reference = "Û∞¨≤";
            Folder = "Û∞âã";
            Event = "Û±êã";
            Operator = "Û∞™ö";
            TypeParameter = "Û∞¨õ";
            Error = "Û∞è≠";
            Warning = "Û∞èØ";
            Information = "Û∞èÆ";
            Hint = "Û∞è≠";

            Emoji = "ü§∂";
          };
        };
        completion = {
          menu = {
            border = "none";
            draw = {
              gap = 1;
              treesitter = [ "lsp" ];
              columns = [
                {
                  __unkeyed-1 = "label";
                }
                {
                  __unkeyed-1 = "kind_icon";
                  __unkeyed-2 = "kind";
                  gap = 1;
                }
                { __unkeyed-1 = "source_name"; }
              ];
            };
          };
          trigger = {
            show_in_snippet = false;
          };
          documentation = {
            auto_show = true;
            window = {
              border = "single";
            };
          };
          accept = {
            auto_brackets = {
              enabled = false;
            };
          };
        };
      };
    lsp = {
      enable = true;
      inlayHints = true;
      servers = {
        ts_ls.enable = true;
        emmet_language_server.enable = true;
        lua-language-server = {
          enable = true;
          settings = {
            format = {
              command = [ "${lib.getExe pkgs.stylua}" ];
            };
          };
        };
        nixd = {
          enable = true;
          settings = {
            format = {
              command = [ "${lib.getExe pkgs.nixfmt-rfc-style}" ];
            };
          };
        };
        tailwindcss.enable = true;
        basedpyright.enable = true;
      };
      keymaps = {
        silent = true;
        lspBuf = {
          K = {
            action = "hover";
          };
          gd = {
            action = "definition";
          };
          gD = {
            action = "declaration";
          };
          gi = {
            action = "implementation";
          };
          go = {
            action = "type_definition";
          };
          gr = {
            action = "references";
          };
          gs = {
            action = "signature_help";
          };
          gl = {
            action = "open_float";
          };
        };
    };
  keymaps = [
    # Oil
    {
      key = "\\";
      action = "<cmd>Oil --float<CR>";
    }
    # Telescope
    {
      key = "<leader>ff";
      action = "<cmd>Telescope find_files<CR>";
      options.desc = "Telescope find files";
    }
    {
      key = "<leader>fg";
      action = "<cmd>Telescope live_grep<CR>";
      options.desc = "Telescope live grep";
    }
    {
      key = "<leader>fb";
      action = "<cmd>Telescope buffers<CR>";
      options.desc = "Telescope buffers";
    }
    {
      key = "<leader>fh";
      action = "<cmd>Telescope help_tags<CR>";
      options.desc = "Telescope help tags";
    }
  ];
  # Options
  opts = {
    number = true;
    relativenumber = true;
    shiftwidth = 4;
    scrolloff = 8;
    cursorline = true;
    colorcolumn = "80";
    termguicolors = true;
    background = "dark";
    signcolumn = "yes";
    updatetime = 50;
  };
  extraConfigLua = ''
    local parser_config = require("nvim-treesitter.parsers").get_parser_configs()
    local _border = "rounded"

    vim.lsp.handlers["textDocument/hover"] = vim.lsp.with(
      vim.lsp.handlers.hover, {
        border = _border
      }
    )

    vim.lsp.handlers["textDocument/signatureHelp"] = vim.lsp.with(
      vim.lsp.handlers.signature_help, {
        border = _border
      }
    )

    vim.diagnostic.config{
      float={border=_border}
    };

    require('lspconfig.ui.windows').default_options = {
      border = _border
    }

    config = function(_, opts)
      local lspconfig = require('lspconfig')
      for server, config in pairs(opts.servers) do
        -- passing config.capabilities to blink.cmp merges with the capabilities in your
        -- `opts[server].capabilities, if you've defined it
        config.capabilities = require('blink.cmp').get_lsp_capabilities(config.capabilities)
        lspconfig[server].setup(config)
      end
    end;
  '';
    }
